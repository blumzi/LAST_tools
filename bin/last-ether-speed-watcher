#!/bin/bash

#
# This script is ran as a systemd script.  It monitors the Ethernet device's
#  counter for carrier changes from DOWN to UP.
#
# Whenever the link turns UP from DOWN, it checks if the device has negotiated a 1000Mb/s speed
#  and uses ethtool to set the speed at 1000Mb/s if the negotiation failed.
#

PROG=$(basename ${0})

device="enp67s0"

function get_speed() {
    ethtool ${device} | awk '$1 == "Speed:" { print $2 }'
}

function get_count() {
    echo $(< /sys/class/net/${device}/carrier_up_count)
}

prev_count=""
while true; do
    count=$(get_count)

    if [ "${count}" != "${prev_count}" ]; then
        sleep 2
        if [ "$(get_speed)" != 1000Mb/s ]; then
            ethtool -s ${device} speed 1000 duplex full autoneg on
            logger -t ${PROG} "Enforced 1000Mb/s on ${device}"
            sleep 5 # let the device recover
        fi
        prev_count=$(get_count)
    fi
    sleep 2
    prev_count=${count}
done
