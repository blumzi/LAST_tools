#!/bin/bash

#
# This script manages the LAST pipeline
#

trap onSIGTERM SIGTERM

function onSIGTERM() {
	local pids

	pids=$(get_pids)
	if [ ! "${pids}" ]; then
		return
	fi
    #shellcheck disable=SC2086
    kill -SIGTERM ${pids}
}

function get_pids() {
    local -a pids
    
    mapfile -t pids < <(pgrep -a MATLAB | grep 'pipeline\.last\.runPipeLAST' | cut -d ' ' -f1)
    echo "${pids[@]}"
}

export LANG=en_US
export LANGUAGE="en_US:en"

declare pids

case "${1}" in
    start)
		# The last-pipeline service is set to run as 'ocs'
        for (( i = 0; i < 3; i++ )); do
            matlab -nodisplay -batch "startup_LAST(false,true); pipeline.last.runPipeLAST(${i})"  &
        done
        
		sleep 5             # wait for matlabs to start running
		pids="$(get_pids)"
		if [ "${pids}" ]; then
            #shellcheck disable=SC2086
			wait ${pids}
		fi
        ;;
esac