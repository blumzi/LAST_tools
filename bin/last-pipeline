#!/bin/bash

#
# This script manages the LAST pipeline
#

trap onSIGTERM SIGTERM

declare -a pids

function onSIGTERM() {
	if [ "${pids[*]}" ]; then
        #shellcheck disable=SC2086
        kill -SIGTERM ${pids[*]}
    fi
}

export LANG=en_US
export LANGUAGE="en_US:en"

case "${1}" in
    start)
		# The last-pipeline service is set to run as 'ocs'
        for (( i = 1; i < 3; i++ )); do
            last-matlab -nodisplay -batch "D=pipeline.DemonLAST; D.Logger.Console=false; D.Logger.Syslog.ProgName='last-pipeline'; D.DataDir=${i}; D.main('StopButton', false);"  &
            pids+=( ${!} )
        done
        
		sleep 5             # wait for matlabs to start running
		if [ "${pids[*]}" ]; then
            #shellcheck disable=SC2086
			wait ${pids[*]}
		fi
        ;;
esac
