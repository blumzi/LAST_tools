#!/bin/bash

source /etc/profile.d/last.sh

#env | grep LAST_

export PROG
PROG=$(basename "${0}")
export LAST_TOOL_PID="${$}"

#source lib/module.sh
module_include lib/message
module_include lib/macmap
module_include lib/deploy

function help() {
    cat << EOF

    This tool sets up the LAST installation on the current machine.

    Usage: ${PROG} config|check|enforce|show [-q|--quiet] [[[-s|--section <name>] ...]
           ${PROG} --help

     The first argument selects the running mode:
        config:              manages configuration files for the selected sections
        check:               checks if the current state of the selected sections meets the requirements
        enforce:             runs code that enforces the requirements for the selected sections
        show:                only show some information

     -s|--section <section>: add <section> to the selection set
     -q|--quiet:             be silent

EOF
}

function show_info() {
    local msg

    export LAST_TOOL_DONTLOG=true   # inform message_xxx not to log
    local deploy_dir
    deploy_dir=$(deploy_media_dir)

    message_info ""
    message_info "Environment:"
    message_info " LAST_BASH_INCLUDE_PATH: ${LAST_BASH_INCLUDE_PATH}"
    message_info "        LAST_TOOL_QUIET: ${LAST_TOOL_QUIET}"
    message_info "                  Media: ${deploy_dir}"
    message_info ""

    message_info "Matlab:"
    message_info "   Installed: $(matlab_installed_release)"
    
    local -a available_matlabs available_matlab_dirs
    if [ "${deploy_dir}" ]; then
        read -r -a matlabs <<< "$(cd "${deploy_dir}/matlab" || exit; echo R*)"
        for matlab in "${matlabs[@]}"; do
            if [ -r "${deploy_dir}/matlab/${matlab}/disk1.iso" ] && [ -r "${deploy_dir}/matlab/${matlab}/disk2.iso" ]; then
                available_matlabs+=( "${matlab}" )
                available_matlab_dirs+=( "${deploy_dir}/matlab/${matlab}" )
            fi
        done

        if [ ${#available_matlabs[*]} -gt 0 ]; then
            for (( i = 0 ; i < ${#available_matlabs[*]}; i++ )); do
                message_info "   Available: ${available_matlabs[i]} in ${available_matlab_dirs[i]}"
            done
        else
            message_info "   Available: None"
        fi
    fi

    local keys_file
    keys_file="$(matlab_file_installation_keys)"
    msg="   Installation Keys File: "
    if [ -r "${keys_file}" ]; then
        msg+="${keys_file}"
    else
        msg+="Missing"
    fi
    message_info "${msg}"

    local license_file
    license_file="$(matlab_license_file)"
    msg="   License File:           "       
    if [ -r "${license_file}" ]; then
        msg+="${license_file}"
    else
        msg+="Missing"
    fi
    message_info "${msg}"
    message_info ""

    message_info "Sections:"
    message_info " Available:"
    for section in $( sections_registered_sections ); do
        message_info "$(printf '   %-12s %s\n' "${section}" "$(sections_section_description "${section}")")"
    done | sort

    message_info ""
    message_info " Selected (ordered, including dependencies):"
    for section in "${needed_sections[@]}"; do
        message_info "$(printf '   %-12s %s\n' "${section}" "$(sections_section_description "${section}")")"
    done

    local mac ipaddr hostname
    mac="$(macmap_get_local_mac)" || message_fatal "Cannot get local MAC"
    ipaddr="$(macmap_get_local_ipaddr)" || message_fatal "Cannot get IP address for local mac: ${mac}"
    hostname="$(macmap_get_local_hostname)" || message_fatal "Cannot get hostname for local mac: ${mac}"
    message_info ""
    message_info "Network:"
    message_info "   MAC:        ${mac:-Could not get it}"
    message_info "   IP address: ${ipaddr:-Could not get it}"
    message_info "   hostname:   ${hostname:-Could not get it}"
    message_info ""
}

function root_or_die() {
    if [ "$(id -un)" != root ]; then
        echo "${PROG}: Must be root to run this tool!"
        exit 1
    fi
}

case "${1}" in
    -h|--help)
        help
        exit 0
        ;;
    
    check|enforce|config|show)
        mode="${1}"
        shift 1
        ;;
esac

if [ ! "${mode}" ]; then
    message_failure "The first argument must select a running mode (check|start|config|show), see help below!"
    help
    exit 1
fi

export LAST_TOOL_MATLAB_VERSION=R2020b # default Matlab release

OPTS=$( getopt -o 'qs:' --long "quiet,section:" -n "${PROG}" -- "$@" )
eval set -- "${OPTS}"

while true; do
	case "${1}" in

    -s|--section)
        selected_sections+=( "${2}" )
        shift 2
        ;;

    -q|--quiet)
        export LAST_TOOL_QUIET=true
        shift 1
        ;;

	--)
		shift 1
		break
		;;
	esac
done

#
# These modules will register sections
#
module_include sections/bios
module_include sections/user
module_include sections/packages
module_include sections/profile
module_include sections/hostname
module_include sections/apt
module_include sections/paths
module_include sections/matlab
module_include sections/filesystems

read -r -a registered_sections <<< "$( sections_registered_sections )"

# No sections were specified, use all those defined
if [ ${#selected_sections[*]} -eq 0 ]; then
    selected_sections=( "${registered_sections[@]}" )
fi

# build a topologically sorted array of the needed section
read -r -a needed_sections <<< "$( sections_ordered_sections "${selected_sections[*]}" )"

case "${mode}" in
show)
    show_info
    exit 0
    ;;

check)
    export LAST_TOOL_DONTLOG=true
    ;;
esac

root_or_die

for section in "${needed_sections[@]}"; do
    if sections_section_has_method "${section}" "${mode}"; then
        eval "${section}_${mode}"
    else
        message_warning "Section \"${section}\" does not have a \"${section}_${mode}\" method, skipping"
    fi
done